<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Curah Hujan Kaltim 2024</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root {
      --bg: #EAF3FA;
      --accent: #1E3A8A;
      --muted: #6B7280;
      --card: #ffffff;
    }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica Neue, Arial;
      background: var(--bg);
      color: rgba(15, 23, 42, 0.95);
    }
    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(8, 15, 25, 0.06);
    }
    .muted { color: var(--muted) }
    .header-blur {
      backdrop-filter: blur(8px);
      background: rgba(255,255,255,0.7);
    }
    .chart-area { height: 320px }
    @media(min-width:1024px){ .chart-area{height:380px} }
  </style>
</head>

<body>
  <nav class="fixed top-0 left-0 right-0 header-blur border-b border-gray-100 z-40">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="https://unmul.ac.id/file/image_mod_name/download/YzQzZWZjZWVhODMzNWNhMzhhZjY4YmI1MTVmMWU5OGZlZWMzNDIyNTlmY2NiNzhkM2FkOTA3ODczNzZiZGZiYjg4YTg0Y2Y0NGFkYjMxYjI3YTRhMTA2Y2RhNzI1MWVlNWViNWI2NmIzMGZkMDM4ZjY1NjI1M2M0ZGMwZGEwNGZGaEp6clRNVVN6ZUJGQmxyUm9oaVZwN292c1E9/Logo%20Universitas%20Mulawarman"
          alt="logo" class="h-9 rounded"/>
        <div>
          <div class="font-semibold text-gray-900">Curah Hujan Kaltim 2024</div>
          <div class="text-sm muted">Dashboard interaktif. Sumber: BMKG</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div class="chip text-sm font-semibold text-blue-900 bg-blue-50 px-3 py-1 rounded-full">Periode: 2024</div>
        <button id="downloadBtn" class="text-sm px-3 py-1 rounded border border-gray-200">Download CSV</button>
      </div>
    </div>
  </nav>

  <div class="pt-20"></div>

  <main class="container mx-auto px-6 pb-12">
    <section class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <div class="lg:col-span-8 card p-4 lg:p-6">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h2 class="text-xl font-semibold">Peta Interaktif Curah Hujan</h2>
            <div class="text-sm muted">Dropdown filter sudah di dalam peta GitHub.</div>
          </div>
        </div>
        <div class="w-full h-[620px] rounded overflow-hidden border border-gray-100">
          <iframe id="mapFrame" src="https://khairufadilah.github.io/curah-hujan-kaltim-2024/"
            class="w-full h-full border-0"></iframe>
        </div>
        <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="p-3 card flex flex-col">
            <div class="text-sm muted">Total Semua Stasiun</div>
            <div id="totalAll" class="text-2xl font-semibold mt-1">— mm</div>
          </div>
          <div class="p-3 card flex flex-col">
            <div class="text-sm muted">Rata-rata Provinsi</div>
            <div id="avgAll" class="text-2xl font-semibold mt-1">— mm</div>
          </div>
          <div class="p-3 card flex flex-col">
            <div class="text-sm muted">Stasiun Tertinggi</div>
            <div id="topStation" class="text-2xl font-semibold mt-1">—</div>
          </div>
        </div>
      </div>

      <aside class="lg:col-span-4 flex flex-col gap-6">
        <div class="card p-4">
          <h3 class="font-semibold">Kontrol Cepat</h3>
          <div class="mt-3 grid grid-cols-1 gap-2">
            <div class="text-sm muted">Pilih Stasiun (maks 3)</div>
            <div id="stationList" class="max-h-44 overflow-auto mt-2"></div>
            <div class="flex items-center gap-2 mt-2">
              <button id="selectTop3" class="text-sm px-3 py-1 rounded bg-blue-600 text-white">Pilih 3 Teratas</button>
              <button id="clearSel" class="text-sm px-3 py-1 rounded border">Bersihkan</button>
            </div>
          </div>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold">Ringkasan</h3>
          <div class="mt-3 text-sm muted" id="insightBox">Memuat data...</div>
        </div>

        <div class="card p-4">
          <h3 class="font-semibold">Unduh & Export</h3>
          <div class="mt-3 text-sm muted">Unduh data stasiun yang dipilih atau ekspor gambar grafik.</div>
          <div class="flex gap-2 mt-3">
            <button id="exportPNG" class="text-sm px-3 py-1 rounded border">Export PNG</button>
            <button id="exportPDF" class="text-sm px-3 py-1 rounded border">Export PDF</button>
          </div>
        </div>
      </aside>
    </section>

    <section class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 card p-4">
        <h3 class="font-semibold mb-2">Perbandingan Rata-rata Bulanan</h3>
        <div class="chart-area"><canvas id="lineCompare"></canvas></div>
      </div>
      <div class="card p-4">
        <h3 class="font-semibold mb-2">Distribusi Rata-rata</h3>
        <div class="chart-area"><canvas id="doughnutAvg"></canvas></div>
      </div>
    </section>

    <section class="mt-6 card p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Perbandingan per Stasiun</h3>
        <div class="flex items-center gap-3">
          <div id="barSubtitle" class="text-sm muted">Menampilkan total tahunan</div>
          <select id="monthFilterPanel" class="border rounded p-2 bg-white text-sm"></select>
        </div>
      </div>
      <div class="chart-area"><canvas id="barStation"></canvas></div>
    </section>

    <footer class="mt-6 text-center text-sm text-gray-500">
      <div class="mb-2 font-semibold text-gray-700">© 2025 Universitas Mulawarman</div>
      <div class="muted">Sumber: BMKG. Kontak: info@unmul.ac.id</div>
    </footer>
  </main>

  <script>
    const MONTHS = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    let rawData=[],processed=[],lineChart,barChart,doughnutChart;

    async function loadData(){
      try{
        const res=await fetch('curah_hujan_kaltim.json');
        rawData=await res.json();
        processed=rawData.map(d=>{
          const monthly=MONTHS.map(m=>parseFloat((d[m]||"0").toString().replace(",", "."))||0);
          return{
            stasiun:(d["Nama Stasiun"]||d["Nama"]||"Unknown").trim(),
            monthly,
            total:parseFloat((d["Total"]||"0").toString().replace(",", "."))||0,
            rata:parseFloat((d["Rata2"]||d["Rata"]||"0").toString().replace(",", "."))||0
          };
        });
        buildUI();renderAll();
      }catch(e){console.error(e);document.getElementById('insightBox').innerText='Gagal memuat data.'}
    }

    function buildUI(){
      const stList=document.getElementById('stationList');
      stList.innerHTML='';
      processed.forEach((p,i)=>{
        const el=document.createElement('label');
        el.className='flex items-center gap-2 p-2 rounded hover:bg-slate-50';
        el.innerHTML=`<input data-idx="${i}" type="checkbox" class="w-4 h-4"><span class="text-sm">${p.stasiun}</span>`;
        stList.appendChild(el);
      });
      document.querySelectorAll('#stationList input[type=checkbox]').forEach((cb,i)=>{
        cb.addEventListener('change',onStationToggle);
        if(i<3)cb.checked=true;
      });
      const monthSel=document.getElementById('monthFilterPanel');
      monthSel.innerHTML=`<option value="">Semua Bulan</option>`+MONTHS.map((m,i)=>`<option value="${i}">${m}</option>`).join('');
      monthSel.addEventListener('change',()=>{renderBarChart();updateInsight()});
      document.getElementById('selectTop3').addEventListener('click',()=>{
        document.querySelectorAll('#stationList input[type=checkbox]').forEach((cb,i)=>cb.checked=i<3);
        renderLineChart();renderDoughnut();updateInsight();
      });
      document.getElementById('clearSel').addEventListener('click',()=>{
        document.querySelectorAll('#stationList input[type=checkbox]').forEach(cb=>cb.checked=false);
        renderLineChart();renderDoughnut();updateInsight();
      });
      document.getElementById('downloadBtn').addEventListener('click',downloadCSV);
      document.getElementById('exportPNG').addEventListener('click',exportChartsPNG);
      document.getElementById('exportPDF').addEventListener('click',()=>alert('Fitur PDF demo.'));
    }

    function getSelectedStations(){
      return Array.from(document.querySelectorAll('#stationList input[type=checkbox]:checked')).map(c=>processed[parseInt(c.dataset.idx)]);
    }
    function onStationToggle(e){
      const checked=document.querySelectorAll('#stationList input[type=checkbox]:checked');
      if(checked.length>3){e.target.checked=false;alert('Pilih maksimal 3 stasiun.');return;}
      renderLineChart();renderDoughnut();updateInsight();
    }

    function renderAll(){renderLineChart();renderBarChart();renderDoughnut();updateSummary();updateInsight();}

    function renderLineChart(){
      const sel=getSelectedStations();
      const ctx=document.getElementById('lineCompare');
      if(lineChart)lineChart.destroy();
      const datasets=(sel.length?sel:processed.slice(0,3)).map((s,idx)=>{
        const colors=['#2563eb','#06b6d4','#f97316'];
        return{label:s.stasiun,data:s.monthly,borderColor:colors[idx]||'#7c3aed',backgroundColor:(colors[idx]||'#7c3aed')+'22',tension:0.2,fill:true,pointRadius:3,pointHoverRadius:6};
      });
      lineChart=new Chart(ctx,{type:'line',data:{labels:MONTHS,datasets},options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom'}},scales:{y:{title:{display:true,text:'Curah Hujan (mm)'}}},animation:{duration:900,easing:'easeOutCubic'}}});
    }

    function renderBarChart(){
      const monthVal=document.getElementById('monthFilterPanel').value;
      const ctx=document.getElementById('barStation');
      if(barChart)barChart.destroy();
      let labels=processed.map(p=>p.stasiun),data=[],subtitle='Menampilkan total tahunan';
      if(monthVal===''){data=processed.map(p=>p.total);}
      else{const mi=parseInt(monthVal);data=processed.map(p=>p.monthly[mi]);subtitle='Menampilkan bulan: '+MONTHS[mi];}
      document.getElementById('barSubtitle').innerText=subtitle;
      barChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:subtitle,data,backgroundColor:generateColors(labels.length)}]},options:{responsive:true,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Curah Hujan (mm)'}}},animation:{duration:1000,easing:'easeOutBounce'}}});
    }

    function renderDoughnut(){
      const ctx=document.getElementById('doughnutAvg');
      if(doughnutChart)doughnutChart.destroy();
      const labels=processed.map(p=>p.stasiun);
      const data=processed.map(p=>p.rata);
      doughnutChart=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:generateColors(labels.length)}]},options:{responsive:true,plugins:{legend:{position:'bottom'}},animation:{duration:800}}});
    }

    function updateSummary(){
      const totalAll=processed.reduce((a,b)=>a+b.total,0);
      const avgAll=processed.reduce((a,b)=>a+b.rata,0)/processed.length;
      const top=processed.reduce((a,b)=>a.total>b.total?a:b);
      document.getElementById('totalAll').innerText=totalAll.toFixed(1)+' mm';
      document.getElementById('avgAll').innerText=avgAll.toFixed(1)+' mm';
      document.getElementById('topStation').innerText=top.stasiun;
    }

    function updateInsight(){
      const sel=getSelectedStations();
      const box=document.getElementById('insightBox');
      if(sel.length===0){box.innerHTML='Tidak ada stasiun terpilih.';return;}
      const combined=Array(MONTHS.length).fill(0);
      sel.forEach(st=>st.monthly.forEach((v,i)=>combined[i]+=v||0));
      const avgPerMonth=combined.map(v=>v/sel.length);
      let maxIdx=0,minIdx=0;
      avgPerMonth.forEach((v,i)=>{if(v>avgPerMonth[maxIdx])maxIdx=i;if(v<avgPerMonth[minIdx])minIdx=i;});
      box.innerHTML=`Stasiun: <b>${sel.map(s=>s.stasiun).join(', ')}</b><br>Bulan tertinggi: <b>${MONTHS[maxIdx]}</b> (${avgPerMonth[maxIdx].toFixed(1)} mm)<br>Bulan terendah: <b>${MONTHS[minIdx]}</b> (${avgPerMonth[minIdx].toFixed(1)} mm)<br>Rata-rata bulanan: <b>${(avgPerMonth.reduce((a,b)=>a+b,0)/avgPerMonth.length).toFixed(1)} mm</b>`;
    }

    function generateColors(n){
      const palette=['#60a5fa','#34d399','#f87171','#fbbf24','#a78bfa','#f472b6','#4ade80','#fb7185','#60a5fa','#7dd3fc'];
      return Array.from({length:n},(_,i)=>palette[i%palette.length]);
    }

    function downloadCSV(){
      const rows=[['Nama Stasiun','Total','Rata-Rata',...MONTHS]];
      processed.forEach(p=>rows.push([p.stasiun,p.total,p.rata,...p.monthly]));
      const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;a.download='Curah Hujan Kaltim 2024.csv';a.click();
      URL.revokeObjectURL(url);
    }

    function exportChartsPNG(){
      if(!lineChart){alert('Tidak ada chart untuk diexport.');return;}
      const url=lineChart.toBase64Image();
      const a=document.createElement('a');
      a.href=url;a.download='chart_line_compare.png';a.click();
    }

    loadData();
  </script>
</body>
</html>
